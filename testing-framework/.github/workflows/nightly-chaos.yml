name: Nightly Chaos Testing

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual triggering
    inputs:
      proptest_cases:
        description: 'Number of proptest cases to run'
        required: false
        default: '10000'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full

jobs:
  chaos-tests:
    name: Extended Chaos Tests
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-chaos-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-chaos-

      - name: Run chaos tests
        run: cargo test --workspace --features chaos --verbose
        env:
          PROPTEST_CASES: ${{ github.event.inputs.proptest_cases || '10000' }}
          RUST_TEST_THREADS: 1
        continue-on-error: true
        id: chaos_tests

      - name: Collect failure artifacts
        if: failure() || steps.chaos_tests.outcome == 'failure'
        run: |
          mkdir -p artifacts/logs
          mkdir -p artifacts/failures

          # Capture test output
          cargo test --workspace --features chaos --verbose 2>&1 | tee artifacts/logs/chaos_test_output.log

          # Extract failed test names
          grep "test result: FAILED" artifacts/logs/chaos_test_output.log > artifacts/logs/failed_tests.txt || true

          # Extract RNG seeds from logs
          grep "TestRng seed:" artifacts/logs/chaos_test_output.log > artifacts/logs/test_seeds.txt || true

      - name: Upload failure artifacts
        if: failure() || steps.chaos_tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: chaos-test-failures-${{ github.run_id }}
          path: |
            artifacts/
            target/debug/deps/*.log
          retention-days: 30

      - name: Create failure summary
        if: failure() || steps.chaos_tests.outcome == 'failure'
        run: |
          echo "# Chaos Test Failures" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Failed Tests" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat artifacts/logs/failed_tests.txt >> $GITHUB_STEP_SUMMARY || echo "No failures captured" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## RNG Seeds" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat artifacts/logs/test_seeds.txt >> $GITHUB_STEP_SUMMARY || echo "No seeds captured" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Artifacts uploaded for debugging. Download from Actions artifacts section." >> $GITHUB_STEP_SUMMARY

      - name: Post success summary
        if: success()
        run: |
          echo "# Nightly Chaos Tests - Success âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All chaos tests passed with extended proptest cases!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Proptest cases: ${{ github.event.inputs.proptest_cases || '10000' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test threads: 1" >> $GITHUB_STEP_SUMMARY

  property-tests:
    name: Extended Property Tests
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Run property tests with high iteration count
        run: cargo test --workspace --features chaos prop_ --verbose
        env:
          PROPTEST_CASES: ${{ github.event.inputs.proptest_cases || '10000' }}
          PROPTEST_MAX_SHRINK_ITERS: 10000
          RUST_TEST_THREADS: 1
        continue-on-error: true
        id: property_tests

      - name: Upload property test artifacts
        if: failure() || steps.property_tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: property-test-failures-${{ github.run_id }}
          path: |
            proptest-regressions/
            target/debug/deps/*.log
          retention-days: 30

  stress-tests:
    name: Stress Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Run stress tests
        run: |
          # Run high-throughput tests 10 times
          for i in {1..10}; do
            echo "Stress test iteration $i/10"
            cargo test --features chaos test_high_throughput_stress --verbose
          done
        env:
          RUST_TEST_THREADS: 1

  report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [chaos-tests, property-tests, stress-tests]
    if: always()
    steps:
      - name: Generate summary report
        run: |
          echo "# Nightly Chaos Testing Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Chaos Tests: ${{ needs.chaos-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Property Tests: ${{ needs.property-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Stress Tests: ${{ needs.stress-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.chaos-tests.result }}" == "success" ] && \
             [ "${{ needs.property-tests.result }}" == "success" ] && \
             [ "${{ needs.stress-tests.result }}" == "success" ]; then
            echo "âœ… **All chaos testing passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some chaos tests failed. Check artifacts for details.**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send notification (on failure)
        if: failure() || needs.chaos-tests.result == 'failure' || needs.property-tests.result == 'failure' || needs.stress-tests.result == 'failure'
        run: |
          echo "Chaos tests failed! Check GitHub Actions artifacts for failure details."
          # Add your notification logic here (Slack, Discord, email, etc.)
