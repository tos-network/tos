//! Network Partition Test
//!
//! Tests network partition recovery and synchronization
//!
//! Run with:
//! ```bash
//! cargo test --package tos_integration_tests --test network_partition
//! ```

use tos_integration::*;

#[tokio::main]
async fn main() -> Result<()> {
    env_logger::init();

    println!("\n{}", "=".repeat(80));
    println!("TOS Network Partition Recovery Test");
    println!("{}", "=".repeat(80));

    // Test configuration
    let num_nodes = 3;
    let network_config = NETWORK_CONFIG_MEDIUM;

    println!("\nTest Configuration:");
    println!("  Nodes: {}", num_nodes);
    println!("  Network: Medium quality (100ms latency, 1% loss)");

    // Create scenario runner
    let daemon_path = std::env::var("TOS_DAEMON_PATH")
        .unwrap_or_else(|_| "./target/debug/tos_daemon".to_string());

    let runner = ScenarioRunner::new(daemon_path);

    // Run network partition recovery test
    let scenario = scenarios::NetworkPartitionRecovery::new(30, 60);

    println!("\nRunning scenario: {}", scenario.name());
    println!("  Partition duration: {} seconds", scenario.partition_duration_secs);
    println!("  Recovery observation: {} seconds", scenario.recovery_observation_secs);

    match runner
        .run_scenario(&scenario, num_nodes, network_config)
        .await
    {
        Ok(report) => {
            report.print_summary();

            // Export results
            let _ = report.export_json("network_partition_report.json");
            let _ = report.export_csv("network_partition_report.csv");

            println!("\n{}", "=".repeat(80));
            println!("Test completed successfully!");
            println!("{}", "=".repeat(80));

            Ok(())
        }
        Err(e) => {
            eprintln!("\nTest failed: {:?}", e);
            Err(e)
        }
    }
}
