# TNS Code Review Bugs

- daemon/src/rpc/rpc.rs:5233-5304 — `is_name_available` only checks length/reserved/confusing and `normalize_name` (whitespace/ASCII). It never enforces the full on-chain format rules (must start with letter, allowed charset, no trailing separator, no consecutive separators). As a result, names like `123abc` or `alice..bob` can be reported as `valid_format: true` and `available: true`, but will be rejected during transaction verification. This violates zero-trust input validation and causes UX issues.
- wallet/src/main.rs:5941-5989 — `register_name` only applies `normalize_name` plus reserved/confusing checks, and then trusts `is_name_available`. It never validates the full format rules locally, so it can construct and broadcast transactions that are guaranteed to fail verification.
- wallet/src/main.rs:6230-6234 — `send_message` hardcodes `message_nonce = 0` with a comment “nonce will be set by transaction builder”, but the builder does not override this. Result: message ID is constant for the same sender/recipient, so only the first message will succeed; subsequent messages are rejected as `MessageAlreadyExists`. This also diverges from the design doc (nonce should come from the tx nonce).
- daemon/src/rpc/rpc.rs:5392-5402 and daemon/src/rpc/rpc.rs:5413-5421 — `get_messages`/`get_message_count` call `get_messages_for_recipient(..., limit = u32::MAX)` and materialize all messages just to count. A large inbox can exhaust memory or stall the RPC (DoS risk). Counting should be done without collecting all messages.
- daemon/src/core/storage/rocksdb/providers/tns.rs:168-215 and daemon/src/rpc/rpc.rs:5361-5450 — Message retrieval does not filter expired messages, and RPC endpoints return stored messages regardless of `expiry_topoheight`. Unless cleanup is guaranteed elsewhere, clients can read messages after TTL, violating the “auto-delete” requirement.
- common/src/transaction/payload/tns.rs:35-40 and common/src/transaction/payload/tns.rs:138-146 — Serializer `write` casts `name.len()` to `u8` and `encrypted_content.len()` to `u16` without bounds checks. Oversized payloads would truncate length fields and corrupt serialization, enabling malformed transactions or parsing ambiguities. Should reject or clamp before serialization.
- wallet/src/main.rs:2013-2017 — Uses `unwrap()` on `multisig_threshold` after checking `is_some()`. While it is guarded, it still violates the “no .unwrap()” guideline and could be refactored to avoid panic paths.
